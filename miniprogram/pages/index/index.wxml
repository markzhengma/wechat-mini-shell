<!--index.wxml-->
<view>
  <swiper 
    class="home-swiper"
		indicator-dots="true" 
		autoplay="true" 
    interval="5000"
    duration="1000"
    indicator-color="#808080"
    indicator-active-color="#f8d148"
    easing-function="easeInOutCubic"
    circular="true"
  >
    <block wx:for="{{bannerList}}" wx:key="unique">
      <swiper-item>
        <image src="{{item.thumb_url}}" style="width: 100%; height: 100%;"/>
      </swiper-item>
    </block>
  </swiper>
  <!-- 已登录 -->
  <view wx:if="{{isLoggedIn}}" >
    <view style="display: flex; flex-direction: column" wx:if="{{uidIsInDB}}">
      <van-cell-group 
        inset
        style="margin-top: 6px"
        >
        <van-cell
          title="{{userData.user_name ? userData.user_name : ''}}"
          label="{{userData.plate ? userData.plate : ''}}"
          center="true"
        >
          <van-button 
            type="default" 
            icon="exchange"
            custom-style="width: 30px; height: 30px"
            bind:click="showUserDataList"
            wx:if="{{userDataList.length > 1}}"
          />
        </van-cell>
      </van-cell-group>
      <!-- TODO: 最近的一条养护提醒 -->
      <van-cell-group 
        inset
        style="margin-top: 6px"
        >
        <van-cell>
          <van-button 
            icon="star-o" 
            size="large"
            custom-style="margin: 16px 0; background-color: #f8d148"
            data-path="/pages/UserRecord/UserRecord"
            bind:click="switchPage"
          >
          查看养护记录
          </van-button>
        </van-cell>
      </van-cell-group>
      <view
        style="margin-top: 6px; padding: 0 6px"
      >
        <van-grid gutter="10" column-num="3" clickable>
          <van-grid-item 
            icon="link-o" 
            text="关联其他账号" 
            id="manual-check" 
            bind:click="checkNonUidDataWithPhone"/>
          <van-grid-item 
            icon="search" 
            text="手动输入查询" 
            bind:tap="showManualSearchForm" />
          <van-grid-item 
            icon="phone-o" 
            text="联系我们"
            bind:tap="showContactPopup" />
        </van-grid>
      </view>
    </view>
    <view style="display: flex; flex-direction: column" wx:else>
      <van-cell-group 
        inset
        style="margin-top: 6px"
        >
        <van-cell
          title="未找到关联的微信号记录"
          center="true"
          icon="user"
        >
        </van-cell>
      </van-cell-group>
      <van-cell-group 
        inset
        style="margin-top: 6px"
        >
        <van-cell>
          <van-button 
            icon="star-o" 
            size="large"
            custom-style="margin: 16px 0; background-color: #f8d148"
            open-type="getPhoneNumber"
            bindgetphonenumber="getPhoneAuthCode"
          >
          通过手机号关联保养记录
          </van-button>
        </van-cell>
      </van-cell-group>
      <view
        style="margin-top: 6px; padding: 0 6px"
      >
        <van-grid gutter="10" column-num="3" clickable>
          <van-grid-item 
            icon="search" 
            text="手动输入查询" 
            bind:tap="showManualSearchForm" />
          <van-grid-item 
            icon="phone-o" 
            text="联系我们" />
        </van-grid>
      </view>
    </view>
  </view>
  <!-- 重新登录等待 -->
  <view style="display: flex; flex-direction: column" wx:elif="{{retryCountdown > 0}}">
    <van-cell-group 
      inset
      style="margin-top: 6px"
      >
      <van-cell>
        <van-button 
          icon="star-o" 
          size="large"
          custom-style="margin: 16px 0; background-color: #f8d148"
          disabled
        >
        重试登录（{{retryCountdown}}秒后）
        </van-button>
      </van-cell>
    </van-cell-group>
    <view
      style="margin-top: 6px; padding: 0 6px"
    >
      <van-grid gutter="10" column-num="3" clickable>
        <van-grid-item 
          icon="search" 
          text="手动输入查询" 
          bind:tap="showManualSearchForm" />
        <van-grid-item 
          icon="phone-o" 
          text="联系我们" />
      </van-grid>
    </view>
  </view>
  <!-- 未登录 -->
  <view style="display: flex; flex-direction: column" wx:else>
    <van-cell-group 
      inset
      style="margin-top: 6px"
      >
      <van-cell>
        <van-button 
          icon="star-o" 
          size="large"
          custom-style="margin: 16px 0; background-color: #f8d148"
          bind:click="setUserData"
        >
        用户登录
        </van-button>
      </van-cell>
    </van-cell-group>
  </view>

<!-- 管理员身份 -->
  <view wx:if="{{isAdmin}}">
    <van-divider contentPosition="center">
      管理员操作
    </van-divider>
    <view
        style="margin-top: 6px; padding: 0 6px"
      >
      <van-grid gutter="10" column-num="3" clickable>
        <van-grid-item 
          icon="todo-list-o" 
          text="查询客户" 
          bind:click="showFindUserForm"/>
        <van-grid-item 
          icon="add-o" 
          text="创建客户" 
          bind:tap="showCreateUserForm" />
      </van-grid>
    </view>
    <van-divider />

    <!-- 查询用户弹窗 -->
    <van-popup 
      show="{{ findUserFormIsShow }}" 
      round
      custom-style="padding: 10px; width: 90%"
      bind:close="hideFindUserForm">
      <view style="padding: 0 16px 16px 16px">查询客户</view>
      <view style="padding: 0 16px 8px 16px; display: flex; flex-direction: row">
        <view >
          <van-button 
            size="small"
            type="warning"
            wx:if="{{findUserFilter == 'plate'}}"
          >
            车牌号
          </van-button>
          <van-button 
            data-filter="plate"
            size="small"
            type="default"
            bind:click="changeFindUserFilter"
            wx:else
          >
            车牌号
          </van-button>
        </view>
        <view >
          <van-button 
            size="small"
            type="warning"
            wx:if="{{findUserFilter == 'phone'}}"
          >
            手机号
          </van-button>
          <van-button 
            data-filter="phone"
            size="small"
            type="default"
            bind:click="changeFindUserFilter"
            wx:else
          >
            手机号
          </van-button>
        </view>
        <view >
          <van-button 
            size="small"
            type="warning"
            wx:if="{{findUserFilter == 'record_num'}}"
          >
            换油证号
          </van-button>
          <van-button 
            data-filter="record_num"
            size="small"
            type="default"
            bind:click="changeFindUserFilter"
            wx:else
          >
            换油证号
          </van-button>
        </view>
      </view>
      <van-field
        value="{{ findUserInput }}"
        id="find-user-input"
        placeholder="请输入{{findUserInputPlaceholder}}"
        bind:change="onChange"
      />
      <van-button 
        type="primary"
        custom-style="margin-left: 16px; width: calc(50% - 16px)"
        bind:click="findUserWithFilterAndValue"
      >
        查询
      </van-button>
      <van-button 
        type="default"
        custom-style="width: calc(50% - 16px)"
        bind:click="hideFindUserForm"
      >
        取消
      </van-button>
    </van-popup>

    <!-- 创建用户弹窗 -->
     <van-popup 
      show="{{ createUserFormIsShow }}" 
      round
      custom-style="padding: 10px; width: 90%;"
      bind:close="hideCreateUserForm">
      <view style="padding: 0 16px 16px 16px">创建用户</view>
      <van-cell-group>
        <van-cell 
          title="门店" 
          value="{{ newUserInput.location }}"
          id="create-location"
          bind:click="showLocationPicker"
        />
        <van-field
          value="{{newUserInput.user_name}}"
          id="create-user-name"
          label="车主姓名"
          placeholder="请输入"
          bind:change="onChange"
        />
        <van-field
          value="{{newUserInput.phone}}"
          id="create-phone"
          label="联系方式"
          type="number"
          placeholder="请输入"
          bind:change="onChange"
        />
        <van-field
          value="{{newUserInput.make}}"
          id="create-make"
          label="车型"
          placeholder="请输入"
          bind:change="onChange"
        />
        <van-field
          value="{{newUserInput.plate}}"
          id="create-plate"
          label="车牌号"
          placeholder="请输入"
          bind:change="onChange"
        />
        <van-button 
          type="primary"
          bind:click="createUser"
          custom-style="margin-left: 16px; width: calc(50% - 16px)"
        >
          创建
        </van-button>
        <van-button 
          type="default"
          bind:click="hideCreateUserForm"
          custom-style="width: calc(50% - 16px)"
        >
          取消
        </van-button>
      </van-cell-group>
    </van-popup>
  </view>

  <van-popup 
    show="{{ findUserListIsShow }}" 
    closeable
    position="bottom"
    custom-style="height: fit-content; padding: 20px 0"
    bind:close="hideFindUserList">
    <view style="padding: 0 16px 8px 16px">找到多个客户</view>
    <block 
      wx:for="{{findUserList}}" 
      wx:key="unique"
      style="{{height: '50vh', overFlow: 'hidden'}}"
    >
      <van-cell-group 
        inset 
        border="{{false}}"
        data-listed-user="{{item}}"
        custom-style="margin: 2px"
        title="{{item.record_num}}"
        bind:tap="takeUserDataToAdminPage">
        <van-cell 
          title="{{item.user_name}}" 
          label="{{item.phone}}"
          value="{{item.plate}} " 
          center
        />
      </van-cell-group>
    </block>
  </van-popup>

  <van-popup
    round
    position="bottom"
    show="{{locationPickerIsShow}}">
    <van-picker
      show-toolbar
      title="门店选择"
      columns="{{ locationList }}"
      bind:confirm="confirmLocationPick"
      bind:cancel="closeLocationPicker"
    />
  </van-popup>

  <van-popup 
    show="{{ userDataListIsShow }}" 
    round
    position="bottom"
    custom-style="height: fit-content; padding: 20px 0"
    bind:close="hideUserDataList">
    <view style="padding: 0 16px 16px 32px">请选择爱车</view>
    <block wx:for="{{userDataList}}" wx:key="unique">
      <van-cell-group 
        inset 
        border="{{false}}"
        data-listed-user="{{item}}"
        custom-style="margin: 2px"
        title="{{item.record_num}}"
        bind:tap="selectFromUserDataList">
        <van-cell 
          title="{{item.make}}" 
          value="{{item.plate}} " 
          center
        />
      </van-cell-group>
    </block>
  </van-popup>
  <van-popup 
    show="{{ manualSearchIsShow }}" 
    position="bottom"
    round
    custom-style="height: fit-content; padding: 20px 0"
    bind:close="hideManualSearchForm">
    <view style="padding: 0 16px 16px 16px">手动输入查询</view>
    <van-cell-group>
      <van-field
        value="{{ userInputPlateAndPhone.plate }}"
        id="manual-search-plate"
        label="车牌号"
        placeholder="请输入"
        bind:change="onChange"
      />
      <van-field
        value="{{ userInputPlateAndPhone.phone }}"
        id="manual-search-phone"
        label="手机号"
        placeholder="请输入"
        bind:change="onChange"
      />
      <van-button 
        type="primary"
        custom-style="margin-left: 16px; width: calc(50% - 16px)"
        bind:click="manualSearchSubmit"
      >
        查询
      </van-button>
      <van-button 
        type="default"
        custom-style="width: calc(50% - 16px)"
        bind:click="hideManualSearchForm"
      >
        取消
      </van-button>
    </van-cell-group>
  </van-popup>

  <van-popup 
    show="{{ isShowContactPopup }}" 
    position="bottom"
    round
    custom-style="height: fit-content; padding: 20px 0"
    bind:close="hideContactPopup">
    <view style="padding: 0 16px 16px 16px">点击联系门店</view>
    <van-cell-group
      wx:for="{{ locationPhoneList }}">
      <van-cell
        title="{{ item.divider }}"
        icon="location-o"
        custom-style="color: gray"
        wx:if="{{ !item.location }}"
      />
      <van-cell
        title="{{ item.location }}"
        value="{{ item.phone }}"
        data-phone="{{ item.phone }}"
        border="{{ false }}"
        icon="phone-o"
        bind:tap="callLocation"
        wx:else
      />
    </van-cell-group>
  </van-popup>

  <van-dialog id="van-dialog" />
  <van-toast id="van-toast" />

</view>